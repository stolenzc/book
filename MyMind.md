## 你们公司是做什么的

公司是一个在线IT学习

## 你在你们公司做了些什么？

我在我们公司担任python高级开发工程师职务，我参与了四个项目，第一个项目是一个雅安茶叶地方电商平台，第二个项目是一个雅安农产品溯源项目，是给雅安食药监做的，第三个项目是。。。，我觉得做的最好的项目是溯源那个项目，我给你讲一下这个项目吧。。。我们这个项目客户是雅安食药监，去年三月份接的，覆盖是整个雅安市2万家以上的食品生产机构，工期是一年，分了两期，我做的是第一期，我们团队刚开始只有三个人，后面我们扩大到八个人，这个项目包含食品生产，食品运输，食品上架等功能，我们采用的是DFR框架，数据库用的mysql数据库。我在其中负责的功能是数据库设计，需求分析，接口开发，框架搭建，难关攻克，

异常值筛选（坏猪肉的检测）

数据库三范式 反范式

## 你们软件开发怎么做的？

我们那个客户是雅安食药监的，去年三月份开始做需求调研的，我们去了三个人，我也去了，有一个项目经理，还有一个ui。需求出了原型图，架构设计（我做的），我们设计用的是DRF， mysql，我们后面是部署到政府的云机房上面的。

## 你们架构咋设计的？

我给你画张图吧，边画图边解释

## 你们后端有多少人？

团队13人，技术总监1人，产品1人，UI1人，测试1人，后端4个人，前端4个人，app1人，

## 具体开发流程说一下

我们采用的是scrum开发模式，我们每天早上要开站立早会，。。。我们每周有代码审查。

## 你遇到了些什么难题，如何解决的

我遇到好几个问题，先说个异常值检测的。
身份验证的，我们用的jwt，里面有个重刷。

## 你们项目如何测试的

我们有专门的测试人员，我们组有两个测试，我们在提交给测试组之前，我们都会进行自测，没有自测通过的代码我们不会提交给测试组。我们公司使用禅道bug管理系统进行bug分配的，我们提交代码的时候都会把禅道的任务编号和任务描述放在备注里面，这样便于后面查找这个bug有哪些相关代码，我们还对复杂的模块进行了单元测试，单元测试我用的是pytest框架。我们测试了view，model，template。

## 说一下你pytest如何用的？

技术结合项目阐述

## 你们如何发起一个测试请求？

我们开发组长给测试组长发一封邮件，邮件里面是待测试的版本号，git代码地址，测试范围，期望测试完成时间。

## 你们测了多久？

其实我们测试很早就进入了，在需求分析的后面阶段就来了，他安排进来分析需求，写测试用例和测试计划。我们是每完成一个接口，内测过后，就交给测试人员，这样我们开发速度快。最后还进行了集成测试，花了两个月时间。我们在修改bug和联调部署准备这些任务。

## 你们做的东西上线没？ 效果如何？

已经上线了，互联网我建议你找一个大一点的，效果比较好的。
我们的用户有300多万，刚开始的时候只有10万左右，后来我们投放了些广告，我们用户上来了，我们就马上做了架构上的调整。我们之前有五台机器，后来撑不住了，我们就做了个负载均衡。

## 程序开发流程

需求分析，设计阶段，功能发开，测试阶段，试运行

## 接口文档

接口文档第一页还有，创建者，版本号等东西。

## 你在Django中如何定义异常的？

首先创建了一个common文件夹，把所有公用的东西放在这里面了，比如说几种异常处理类我就放到这里面的，取了个名字叫ErrorHandleMiddleWare，还有异常编码类ErrorCode。

我在settings里面就把异常处理中间件配置再中间件里面，当我的程序发生异常的时候，就会走这个中间件。异常有两种，一种是我主动抛出的，也就是我定义的，一种是系统发生的系统异常，我的中间件里面都有分开处理的逻辑，我使用isinstance来进行判定的。

我自己抛出的异常一般是验证参数时候发生的，比如说手机号规范我用正则验证，不一致我就抛出异常代码为手机号不合格的异常。这个异常类是我自己定义的，是继承BaseException基类，我只要传入不同的code，message，data就行了。捕获到异常后，把异常转换成json返回，前端就收到了错误代码和错误原因。我除了通知前端出错之外，我还进行了错误日志记录，我是用的是logging包，然后按天记录的，只保留30的日志记录

## 你的系统如何鉴权的？

## 你的系统如何验证参数的

中间件

## 你的系统如何处理日志的

## 你的系统如何数据备份的

我们的系统数据层是用mysql做的，我那个项目有三台机器，一个主机，两个从机，做了一个主从数据库备份。我们备份是按全量和增量模式来做的，同时也分热备和冷备。全量备份我们是对整个数据库进行备份，我们安排在周天。增量备份是周一到周六每天备份当天的增量数据任何一天掉了，用全量加上前面的增量进行还原。全量备份用mysqldump加上crontab定时。备份的数据我们放在专用磁盘上的，定期会对磁盘进行归档，归档是运维做的。

## 你的系统如何部署的

## 你的系统如何处理高并发的

横向扩展

## 你听过做过异地灾备没有？

异地灾备就是源和备份目的地不在同一个机房或者同一个城市或者同一个国家

## 你的这个电商网站是如何做支付的？

我们使用了微信支付和阿里支付接口，我负责其中微信支付接口。我说一下微信支付流程吧。

首先给用户显示商品信息，用户如果想购买，将该商品加入到购物车中，然后用户点击结算按钮，然后跳到结算详情信息页面。用户点击支付，选择支付方式，如果选择用微信支付，我们这个网站分PC端和手机端两个，PC端就会弹出微信支付二维码，用手机扫码支付，如果用户是在手机端购买，直接点击支付按钮就可以了。

二维码使用qrcode生成的

## 请你深入说一下技术细节

我们使用公司的微信服务号做的微信支付接入，有一个微信的支付接入文档，参照那个流程做的。
1. 首先分用户端、微信端、我们的后台端、微信支付后台端
2. 二维码支付的方式我们用的是Native支付，点按钮支付我们用的JSAPI方式。
3. 我们后台端在收到用户下单请求时我们会调用微信的统一支付接口，我们会将订单号appid， openid...、商品描述、商品价格（价格用的是分为单位），异步通知url等信息传给微信支付后台端
4. 微信支付后台端会生成预支付编号传给我们后台，我们后台签名加密过后（我们的前面加密用的网上的python SDK做的，有专门的密钥文件）会传给微信客户端。
5. 微信客户端提示用户输入密码进行授权，用户输入密码后会发起真正的调用直接到微信支付后台，腾讯扣费后会发起回调到我们的后台服务器，通知我们是否付款成功。（通过我们在统一支付接口传过去的回调通知url通知我们的）
6. 如果我们收到腾讯付款成功，我这个地方还做了一个检查，为了防止其他恶意的欺诈（比如说假冒腾讯的回调），通过主动发起查询订单请求，二次确认是否扣款成功。当扣款真正成功时，我才修改发货流程。
7. 如果是虚拟商品，直接修改订单商品状态。如果是实物商品发货流程我是用的菜鸟裹裹（可选择）
8. 微信支付流程里面的所有的请求参数和响应参数，我都记录到支付请求响应历史表中，方便和微信对账

## Django如何上传文件

## DRF如何上传文件

## 文件类型检查和文件名如何做的

## 数据库三范式

我的项目中也会按需要反范式，比如说有些统计信息我会加到表里面，加快速度

## 数据库设计

使用powerdesigner进行表设计，设计了后转换为物理模型，然后调整物理模型中的主键，外键关联，然后导出为sql，数据库中执行sql创建表。

项目中使用inspectdb进行反向迁移，迁移后改变外键关联。然后用shell或者pytest进行模型测试。

## 你的项目里面数据库的表是不是都建了主外键的？

一般情况下所有的业务表都要建主外键的。但是可能有些项目我们为了数据录入快，项目开发方便，我们没有在前期建立外键，是通过程序去判断的。

## Django中如何做事务控制

## 设计一个url，符合某种规则（url配置和正则）

## 在Django项目中有没有遇到性能问题，如何解决的？

1. 首先我要确定什么地方有性能问题？是什么样的性能问题？通过selenium自动化测试可以记录每个访问的时间，人工测试出来的问题，接口慢、页面慢，我通过开发者工具看网络请求，看哪个地方慢，是静态资源慢还是动态资源慢，
2. 如果是静态资源慢（图片的裁剪和压缩、js压缩、多个js可以合并为一个js，是否静态资源是用web服务器nginx处理，或者放到阿里云oss上面去，或者看下有没有CDN）
3. 动态资源慢，要确定到底是view视图里面的处理慢还是数据库语句慢，用开始时间和结束时间看语句块的运算时间确定是哪个语句块慢，循环是否太多，或者大量的计算之类能不能弄成异步，如果是数据库慢，需要首先看Model执行的原生语句，看一下是否有1+N查询问题select_related，自己写一个元素的sql语句，先达到你预想的性能，在想办法转换为Model语法
